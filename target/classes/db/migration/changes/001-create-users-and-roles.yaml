databaseChangeLog:
  - changeSet:
      id: 001-create-users-and-roles
      author: Ika
      changes:
        - createTable:
            tableName: users
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: email, type: VARCHAR(255), constraints: { nullable: false, unique: true } }
              - column: { name: password_hash, type: VARCHAR(255), constraints: { nullable: false } }
              - column: { name: full_name, type: VARCHAR(255), constraints: { nullable: false } }
              - column: { name: enabled, type: BOOLEAN, defaultValueBoolean: true, constraints: { nullable: false } }
              - column: { name: created_at, type: TIMESTAMP WITH TIME ZONE, defaultValueComputed: NOW(), constraints: { nullable: false } }
              - column: { name: updated_at, type: TIMESTAMP WITH TIME ZONE, defaultValueComputed: NOW(), constraints: { nullable: false } }


        - createTable:
            tableName: roles
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true, nullable: false } }
              - column: { name: name, type: VARCHAR(32), constraints: { nullable: false, unique: true } }

        - createTable:
            tableName: user_roles
            columns:
              - column: { name: user_id, type: UUID, constraints: { nullable: false } }
              - column: { name: role_id, type: BIGINT, constraints: { nullable: false } }
        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role_id
            constraintName: pk_user_roles

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_user_roles_user
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: role_id
            referencedTableName: roles
            referencedColumnNames: id
            constraintName: fk_user_roles_role
            onDelete: RESTRICT

        - createIndex:
            tableName: users
            indexName: idx_users_email
            unique: true
            columns:
              - column: { name: email }

      rollback:
        - dropTable: { tableName: user_roles, cascadeConstraints: true }
        - dropTable: { tableName: roles, cascadeConstraints: true }
        - dropTable: { tableName: users, cascadeConstraints: true }